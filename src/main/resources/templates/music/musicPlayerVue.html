<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">
<head th:include="common :: header"></head>
		<meta charset="utf-8">
		<title>音乐播放器</title>

		<style type="text/css">
			.selectRowClass{
				background-color:grey;
				color:white;
			}
			.thClass{
				background-color:green;
				height: 28px;
			}
			
			.mouseonClass{
				background-color:#ffc107;
			}

			#musicTable th{
				color:white;
				text-align:center;
			}
			
			#musicTable td{
				text-align:center;
			}
			#addMusic{
				width:100%;
				height:5%;
				margin:0 auto;
				border-bottom:1px solid grey;
				padding-top: 2px;
			}
			
			#playerDiv{
				width: 100%;
			    height: 93.4%;
			    margin: 0px auto;
			}

			#uploadResultDiv{
				padding-left: 10px;
				padding-top: 5px;
			}
			#uploadResultDiv p{
				border-bottom: 1px solid grey;
				height:25px;
			}
			#uploadResultDiv span{
				display: inline-block;
			}
		</style>
	</head> 
	<body>
		<div id="addMusic" align="center">
			<form action="/upload/app/uploadMusic" method="post" enctype="multipart/form-data" onsubmit="return verify()" target="hidden_frame">
				<input type="text" id="user" name="user" th:value="${user}" hidden="true">
				<input type="hidden" name="folder" value="music">
				文件:<input id="fileInput" type="file" name="file" multiple="multiple" accept="audio/mpeg" style="display: inline-block;" th:title="#{btn.choosesong.label}">
                <input type="submit" th:value="#{btn.uploadsong.label}">
			</form>
		</div>		
		<div id="playerDiv">
			<div id="buttons" style="height:15%;border-bottom: 1px solid grey;">
				<div id="songNameDiv" align="center" style="background-color:yellow;height:35%;border-bottom:2px solid green;padding-top:7px;">
					<span id="statusSpan">初始化:</span><label id="songName"></label>
				</div>
				<div style="height:67%;">
					<div style="float:left;width:37%;height:46px;margin-top:5px;margin-left: 5px;">
						<audio id="player" controls="controls" src="" style="width:100%;height:100%;"></audio>
					</div>

					<div style="float:right;margin-top:10px;width:60%;">
						<div style="float:left;margin-left:10px;height:40px;">
							<button id="btnPre" class='btn btn-primary' @click="preMusic()" th:title="#{btn.last.tips}">
                                <span class="glyphicon glyphicon-step-backward"></span>
                            </button>
							<button id="btnPlay" class='btn btn-success' @click="play()" th:title="#{btn.play.tips}">
                                <span class="glyphicon glyphicon-play"></span>
                            </button>
							<button id="btnNext" class='btn btn-primary' @click="nextMusic()" th:title="#{btn.next.tips}">
                                <span class="glyphicon glyphicon-step-forward"></span>
                            </button>
							<button id="btnRefresh" class='btn btn-info' @click="refreash()" th:title="#{btn.refreash.tips}">
                                <span class="glyphicon glyphicon-refresh"></span>
                            </button>
                            <button id="btnShowList" class='btn btn-warning' @click="showList()">[[#{btn.hidelist.label}]]</button>
						</div>
						<div id="playModeDiv" style="float:left;margin-top:12px;margin-left:6px;">
							<input type="radio" name="playmode" value="-1" checked="checked" th:title="#{radio.none.tips}">[[#{radio.none.tips}]]&nbsp;&nbsp;
							<input type="radio" name="playmode" value="0" th:title="#{radio.loop.tips}">[[#{radio.loop.tips}]]&nbsp;&nbsp;
							<input type="radio" name="playmode" value="1" th:title="#{radio.order.tips}">[[#{radio.order.tips}]]&nbsp;&nbsp;
							<input type="radio" name="playmode" value="2" th:title="#{radio.random.tips}">[[#{radio.random.tips}]]
						</div>
					</div>
				</div>
			</div>
			
			<div id="musicList" style="overflow-y: scroll;height:86.5%;">
				<table id="musicTable" style="width:100%;border-collapse:separate; border-spacing:1px 4px;">
					<tr class="thClass">
						<th style="width:60px;">选择</th>
						<th style="width:60px;">主键</th>
						<th style="width:200px;">歌曲名称</th>
						<th style="width:60px;">大小</th>
						<th style="width:40px;">访问性</th>
						<th style="display:none;">url</th>
						<th style="width:40px;">操作</th>
					</tr>
					<tr v-for="(music,index) in musicData" :key="index" @mouseenter="mouseEnter(music, index)" @mouseleave="mouseLeave(music, index)">
						<td>
							<div v-if="index==0">
								<input type='radio' name='selectMusic' checked="checked"/>
							</div>
							<div v-else>
								<input type='radio' name='selectMusic'/>
							</div>
						</td>
						<td>{{music.id}}</td>
						<td @dblclick="doublePlay(index)">{{music.filename}}</td>
						<td>{{(parseInt(music.fileSize)/1024.0/1024.0).toFixed(0)}}M</td>
						<td>{{music.accessStatus == '0'?'不可访问':'可访问'}}</td>
						<td>
							<button class='delBtn btn btn-sm btn-success' @click="playMusic(music.id)">
                                <span class="glyphicon glyphicon-play"></span>
                            </button>
							<button class='delBtn btn btn-sm btn-danger' @click="deleteMusic(music.id)">
                                <span class="glyphicon glyphicon-remove"></span>
                            </button>
						</td>
					</tr>
				</table>
			</div>
		</div>
		<iframe name="hidden_frame" id="hidden_frame" style='display: none'></iframe>
		<div th:include="common::footer"></div>
	</body>

	<script type="text/javascript">
		// 加载国际化
		$.ws.i18nInit("[[${#locale.language}]]", "[[${#locale.country}]]");

		//播放模式 0:单曲循环 1:顺序播放 2:随机播放
		var playMode = -1;

		var app = new Vue({
			el: '#playerDiv',
			data: {
				musicData: {},
				curSelectedIndex: 0,
				hoverIndex: -1,
                playStatus: -1,  //播放状态 -1:初始化  0:播放中 1:暂停中
				showMode:1, //播放列表显示/隐藏  0:隐藏 1:显示
			},
			methods: {
				queryMusicList:function () {
					var fileType = ".mp3";
					var user = $('#user').val();
					$.ajax({
						type: "POST",
						url: rootUrl + "file/showFiles.do",
						data: {user: user, fileType: fileType},
						success: function (result) {
							if (result.code == 1) {
								app.musicData = result.data;
							}
						}
					});
				},
				doublePlay:function(musicIndex){
					//双击播放
					console.log("双击播放:"+musicIndex);
					app.curSelectedIndex = musicIndex;
					var selectedTr = $("table tr").get(app.curSelectedIndex+1);
					app.playByIndex(selectedTr);
				},
				play:function(){
					//播放
					console.log("开始播放音乐");
					var checkedInput=$("table tr").find("input[checked='checked']");
					var checkedTr=$(checkedInput).parent().parent().parent();
					var selectedMusicInfo = app.musicData[app.curSelectedIndex];
					var filename = selectedMusicInfo.filename;
					var url = selectedMusicInfo.url;

					$("table input").removeAttr("checked");
					$(checkedInput).prop("checked",true);
					$(checkedInput).attr("checked","checked");
					$("table tr").removeClass("selectRowClass");
					$(checkedTr).addClass("selectRowClass");
					$("#player").attr("src",url);

					$("#statusSpan").text("正在播放:");
					$("#songName").html(filename);
					if (app.playStatus == -1 || app.playStatus == 1){
                        app.playStatus = 0; //播放中
						$("#player")[0].play();
						$("#btnPlay span").removeClass("glyphicon-play").addClass("glyphicon-pause");
					}else{
                        app.playStatus = 1; //暂停中
						$("#statusSpan").text("暂停中:");
						$("#player")[0].pause();
                        $("#btnPlay span").removeClass("glyphicon-pause").addClass("glyphicon-play");
					}
				},
				nextMusic:function(){
					//下一首
                    if (playMode == -1 || playMode == 1) {
                        if (app.curSelectedIndex >= app.musicData.length - 1) {
                            app.curSelectedIndex = 0;
                        } else {
                            app.curSelectedIndex = app.curSelectedIndex + 1;
                        }
                        var selectedTr = $("table tr").get(app.curSelectedIndex + 1);
                        app.playByIndex(selectedTr);
                    } else if (playMode == 0){
                        app.play();
                    } else if (playMode == 2){
                        app.randomMusic();
                    }
                    app.playStatus = 0;
				},
				preMusic:function(){
					//上一首
                    if (playMode == -1 || playMode == 1) {
                        if (app.curSelectedIndex == 0) {
                            app.curSelectedIndex = app.musicData.length - 1;
                        } else {
                            app.curSelectedIndex = app.curSelectedIndex - 1;
                        }
                        var selectedTr = $("table tr").get(app.curSelectedIndex + 1);
                        app.playByIndex(selectedTr);
                    } else if (playMode == 0){
                        app.playStatus = 1;
                        app.play();
                    } else if (playMode == 2){
                        app.randomMusic();
                    }
				},
				playByIndex:function(trObj){
					var selectedInput = $(trObj).find("input");
					$("table input").removeAttr("checked");
					$(selectedInput).prop("checked",true);
					$(selectedInput).attr("checked", "checked");
					$("table tr").removeClass("selectRowClass");
					$(trObj).addClass("selectRowClass");

					var selectedMusicInfo = app.musicData[app.curSelectedIndex];
					var filename = selectedMusicInfo.filename;
					var url = selectedMusicInfo.url;

					$("#player").attr("src", url);
					$("#statusSpan").text("正在播放:");
					$("#songName").html(filename);

					$("#player")[0].play();
                    $("#btnPlay span").removeClass("glyphicon-play").addClass("glyphicon-pause");
				},
				randomMusic:function(){
					// 随机播放
					var randomNum = randomNumber(0,app.musicData.length-1);
					app.curSelectedIndex = randomNum;
					var selectedTr = $("table tr").get(app.curSelectedIndex+1);
					app.playByIndex(selectedTr);
				},
                playMusic:function(id){
                    $.each(app.musicData, function (i,row) {
                        if (row.id == id){
                            app.curSelectedIndex = i;
                            var selectedTr = $("table tr").get(app.curSelectedIndex+1);
                            app.playByIndex(selectedTr);
                        }
                    })
                },
				deleteMusic:function(id) {
					//删除音乐
					layer.confirm("确定删除吗?", {btn: ['确定', '取消'], title: "提示"},
						function (){
							$.ajax({
								type:"POST",
								url:rootUrl + "file/delFile.do",
								data:{id:id},
								success:function(result){
									if (result == "success"){
										layer.msg("删除成功");
										app.queryMusicList();
									}
								}
							});
						}
						,function (){layer.close()}
					);
				},
                mouseEnter:function (music, index) {
					// 鼠标进入事件
                    $.each($("#musicTable tr"), function(i,item){
                        var itemId = $(item).children().eq(1).text();
                        if (itemId == music.id && !$(item).hasClass("thClass") && !$(item).hasClass("selectRowClass")){
                            $(item).addClass("mouseonClass");
                        }else {
                            $(item).removeClass("mouseonClass");
                        }
                    });
                },
                mouseLeave:function (music, index) {
                    // 鼠标离开事件  do nothing
                },
				showList: function (){
					if (app.showMode == 0){
						$("#musicList").slideDown(500);
						$("#btnShowList").text($.ws.i18n("btn.hidelist.label"));
						app.showMode = 1;
					}else{
						$("#musicList").slideUp(500);
						$("#btnShowList").text($.ws.i18n("btn.showlist.label"));
						app.showMode = 0;
					}
				}
			},
			created: function () {
				this.queryMusicList();
			}
		});

		// 播放模式监听
		$("#playModeDiv input[name='playmode']").each(function(index, val){
			$(val).click(function(){
				playMode = $(val).val();
				console.log("playMode:"+playMode);
			})
		})

		// 刷新音乐列表
		function refreash(){
			window.location.href = window.location.href;
		}

        //上传文件校验
        function verify(){
            var uploadFiles=$("#fileInput").val();
            if (uploadFiles == ""){
                return false;
            }
            layer.msg('正在上传文件，请稍候……', { icon: 16, shade: 0.2,shadeClose:false,time:300000 });
            return true;
        }

        $("#hidden_frame").load(function(){
            var bodyText=$(this).contents().find("body").text();
            var uploadRes = JSON.parse(bodyText);
            var showText = "<div id='uploadResultDiv'>";
            $.each(uploadRes,function(i,val) {
                var filename = val.filename;
                var uploadFlag = val.uploadFlag;
                if (uploadFlag){
					showText += "<p><span style='width:82%;'>"+filename+"</span><span style='width:15%;color:blue;font-weight: bold;'>上传成功</span></p>";
                }else{
					showText += "<p><span style='width:82%;'>"+filename+"</span><span style='width:15%;color:blue;font-weight: bold;'>上传失败</span></p>";
                }
            });
			showText+="</div>";
            layer.closeAll();
			layer.open({
				type: 1,
				title: "上传结果",
				shadeClose: true,
				shade: 0.2,
				offset: "20%",
				area: ['530px', '60%'],
				content: showText
			});
            //layer.alert(showText);
            setTimeout(refreash,3000);
        });

		// 绑定事件
		Media = document.getElementById("player");
		var eventTester = function(e){
	        Media.addEventListener(e,function(){
	            if (e == "ended"){
	            	if (playMode == 0){
	            		// 单曲循环
						console.log("单曲循环");
						//$("#btnPlay").text("播放");
                        app.playStatus = 1;
	            		app.play();
	            	}else if (playMode == 1){
	            		//顺序播放
						console.log("顺序播放");
	            		app.nextMusic();
	            	}else if (playMode == 2){
	            		//随机播放
						console.log("随机播放");
	            		app.randomMusic();
	            	}
	            }else if (e == "error"){
	            	if (playMode == 1 || playMode == 2){
						app.nextMusic();
	            	}
	            }
	        });
	    }

	    eventTester("loadstart");    //客户端开始请求数据
	    eventTester("progress");    //客户端正在请求数据
	    eventTester("suspend");        //延迟下载
	    eventTester("abort");        //客户端主动终止下载（不是因为错误引起），
	    eventTester("error");        //请求数据时遇到错误
	    eventTester("stalled");        //网速失速
	    eventTester("play");        //play()和autoplay开始播放时触发
	    eventTester("pause");        //pause()触发
	    eventTester("loadedmetadata");    //成功获取资源长度
	    eventTester("loadeddata");    //
	    eventTester("waiting");        //等待数据，并非错误
	    eventTester("playing");        //开始回放
	    eventTester("canplay");        //可以播放，但中途可能因为加载而暂停
	    eventTester("canplaythrough"); //可以播放，歌曲全部加载完毕
	    eventTester("seeking");        //寻找中
	    eventTester("seeked");        //寻找完毕
	    eventTester("timeupdate");    //播放时间改变
	    eventTester("ended");        //播放结束
	    eventTester("ratechange");    //播放速率改变
	    eventTester("durationchange");    //资源长度改变
	    eventTester("volumechange");    //音量改变
	</script>
</html>
