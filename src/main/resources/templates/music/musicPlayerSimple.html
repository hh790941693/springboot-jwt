<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="common :: header"></head>
		<meta charset="utf-8">
		<title>音乐播放器</title>

		<style type="text/css">
			*{
				margin:0;
				padding:0;
			}
			#mainDiv{
				width:168px;
				height:100%;
				overflow:hidden;
			}
			
			#mainDiv button{
				width:50px;
				height:24px;
				font-size:5px;
			}

			#playerDiv{
				display:none;
			}
		</style>
	</head> 
	<body>
		<div id="mainDiv">
			<div id="buttons">
				<div id='playerDiv' style="width:1px;">
					<audio id="player" controls="controls" src="" style="width:100%;"></audio>
				</div>
				<div style="width:100%;height:25px;margin-left:3px;margin-top:5px;">
					<button id="btnPre" @click="preMusic()">&lt;&lt;</button>
					<button id="btnPlay" @click="play()">播放</button>
					<button id="btnNext" @click="nextMusic()">&gt;&gt;</button>
				</div>
				<div id="songNameDiv" style='font-size:8px;margin-top:5px;' >
					<span id="statusSpan">{{playTips}}:</span><br/><span id="songNameSpan" style='color:green;'>{{songName}}</span>
				</div>
			</div>
		</div>

		<div th:include="common::footer"></div>
	</body>

	<script type="text/javascript">
		// 全局变量
		var playMode = 1; //播放模式   默认为顺序播放
		//当前用户
		var loginUser = parent.s_user;

		var app = new Vue({
			el: '#mainDiv',
			data: {
				musicData: {},
				songName:'',
				curSelectedIndex:0,
				playTips:'等待播放'
			},
			methods: {
				queryMusicList:function () {
					$.ajax({
						type: "POST",
						url: rootUrl + "file/showFiles.do",
						data: {'user': loginUser, 'fileType': "music"},
						success: function (result) {
							if (result.code == 1) {
								app.musicData = result.data;
							}
						}
					});
				},
				play:function(){
					//播放
					if (app.musicData == null || app.musicData == undefined || app.musicData.length == 0){
						return;
					}
					console.log("开始播放音乐");
					var selectedMusicInfo = app.musicData[app.curSelectedIndex];
					var filename = selectedMusicInfo.filename;
					var url = selectedMusicInfo.url;

					$("#player").attr("src",url);
					app.playTips = "正在播放";
					app.songName = filename;
					var btnText = $("#btnPlay").text();
					if (btnText == "播放"){
						btnText = "暂停";
						$("#player")[0].play();
					}else{
						btnText = "播放";
						app.playTips = "暂停中";
						$("#player")[0].pause();
					}
					$("#btnPlay").text(btnText);
				},
				nextMusic:function(){
					//下一首
					if (app.curSelectedIndex>=app.musicData.length-1){
						app.curSelectedIndex = 0;
					}else{
						app.curSelectedIndex = app.curSelectedIndex+1;
					}
					$("#btnPlay").text("播放");
					app.play();
				},
				preMusic:function(){
					//上一首
					if (app.curSelectedIndex==0){
						app.curSelectedIndex = app.musicData.length-1;
					}else{
						app.curSelectedIndex = app.curSelectedIndex-1;
					}
					$("#btnPlay").text("播放");
					app.play();
				},
				randomMusic:function(){
					// 随机播放
					var randomNum = randomNumber(0,app.musicData.length-1);
					app.curSelectedIndex = randomNum;
					app.play();
				},
			},
			created: function () {
				this.queryMusicList();
			}
		});

		// 绑定事件
		Media = document.getElementById("player");
		var eventTester = function(e){
	        Media.addEventListener(e,function(){
	            if (e == "ended"){
	            	if (playMode == 0){
	            		// 单曲循环
						$("#btnPlay").text("播放");
	            		app.play();
	            	}else if (playMode == 1){
	            		//顺序播放
						app.nextMusic();
	            	}else if (playMode == 2){
	            		//随机播放
						app.randomMusic();
	            	}
	            }else if (e == "error"){
	            	if (playMode == 1 || playMode == 2){
						app.nextMusic();
	            	}
	            }
	        });
	    }
	    eventTester("loadstart");    //客户端开始请求数据
	    eventTester("progress");    //客户端正在请求数据
	    eventTester("suspend");        //延迟下载
	    eventTester("abort");        //客户端主动终止下载（不是因为错误引起），
	    eventTester("error");        //请求数据时遇到错误
	    eventTester("stalled");        //网速失速
	    eventTester("play");        //play()和autoplay开始播放时触发
	    eventTester("pause");        //pause()触发
	    eventTester("loadedmetadata");    //成功获取资源长度
	    eventTester("loadeddata");    //
	    eventTester("waiting");        //等待数据，并非错误
	    eventTester("playing");        //开始回放
	    eventTester("canplay");        //可以播放，但中途可能因为加载而暂停
	    eventTester("canplaythrough"); //可以播放，歌曲全部加载完毕
	    eventTester("seeking");        //寻找中
	    eventTester("seeked");        //寻找完毕
	    eventTester("timeupdate");    //播放时间改变
	    eventTester("ended");        //播放结束
	    eventTester("ratechange");    //播放速率改变
	    eventTester("durationchange");    //资源长度改变
	    eventTester("volumechange");    //音量改变
	</script>
</html>
