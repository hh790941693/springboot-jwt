<html xmlns:th="http://www.thymeleaf.org">
<head th:include="common :: header"></head>
	<title>WebSocket客户端</title>
    <style type="text/css">
        #headerDiv{
            width:1318px;
            height:55px;
            font-weight:bold;
            margin:1px auto;
			border: 2px solid green;
			background-image: url("../img/headerX.jpg");
			background-repeat: no-repeat;
			background-size: 100% 771px;
			background-position: 0px -230px;
        }

        #curTimeSpan{
            margin-left:20px;
            font-size:18px;
        }

        #footDiv{
            width:1320px;
            height:45px;
            color:black;
            font-size:15px;
            font-weight:bold;
            margin:1px auto 0 auto;
        }

        #copyrightDiv ul li{
            float:left;
            list-style:none;
        }

		#mainDiv{
			width:1318px;
			height:610px;
			margin:1px auto;
		}

		#leftNavi{
			width:180px;
			height:100%;
			float:left;
			border:2px solid green;
			background-image: url("../img/headerX.jpg");
			background-repeat: no-repeat;
			background-size: 1024px 147%;
			background-position: -10px -222px;
		}

        #leftNavi ul{
            height:495px;
			margin-top: 10px;
        }

        #leftNavi ul li{
            list-style: none;
            height: 40px;
            width: 100%;
            font-size: 20px;
            font-weight: bold;
            padding: 4px;
            cursor: pointer;
        }
        #leftNavi ul a{
            text-decoration:none;
        }

        .mousemoveon{
            background-color:grey;
            color:white;
        }
        .mousemoveout{
            background-color:transparent;
            color:black;
        }
        .mouseleftclick{
            background-color:blue;
            color:white;
        }
        #qrDiv{
            position: fixed;
            right: 5px;
            top: 40px;
            width: 180px;
            height: 180px;
        }
        #qrcodeImg{
            width: 160px;
            height: 160px;
        }

        #unreadCountSpan{
            color: red;
            font-weight: bold;
            margin-left: 10px;
            font-size: 18px;
            margin-left: 45px;
        }

        #musicIframeDiv {
            position: absolute;
            width:175px;
            height:100px;
            background: black;
            color: rgb(255%,255%,255%);
        }
        #musicIframeHeader {
            background: #ddd;
            cursor: move;
            font-size:10px;
        }

		#statusDiv{
			width:1320px;
			height:20px;
			font-size:15px;
			font-weight:bold;
			margin-top:2px;
		}

		#statusTips{
			width: 100%;
			display: inline-block;
			margin-top: -10px;
		}
    </style>
</head>
<body>
    <!--头部-->
	<div id="headerDiv" align="center">
		<div style="float:left;margin-left: 3px;margin-top: 2px;">
			<img id='myImg' alt=""  width="48" height="48">
			<label style="font-size: 20px;">你好:</label><label id="curUser" th:text="${user}" style="color:blue;font-size:28px;"></label>
			<span id="curTimeSpan">0000-00-00 00:00:00</span>
		</div>

		<div id="headerTitleDiv" style="float:left;font-size:30px;width:44%;display: none;">
			<label id="titleLabel" style="color:black;">websocket客户端</label>
		</div>

		<div id="weatherDiv" style="float:left;font-size:20px;width:53%;padding-top:13px;display: block;">
			<label id="weatherInfo" style="color:black;"></label>&nbsp;&nbsp;
			<label id="lastUpdateTime" style="color:black;"></label>&nbsp;&nbsp;
			<label id="location" style="color:black;"></label>
		</div>
		<div id="btnDiv" style="float:right;margin-right:5px;padding-top:13px;">
			<button id="showQRCodeBtn" class='btn btn-sm btn-success'>扫码登录</button>
			<button id="setPersonInfoBtn" class="btn btn-sm btn-primary">设&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;置</button>
			<button id="exitBtn" class='btn btn-sm btn-danger' style="margin-left:10px;" onclick="toIndex()">退&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;出</button>
		</div>
	</div>

	<!--二维码-->
	<div id="qrDiv" style="display:none">
		<img id="qrcodeImg">
	</div>
	<!--中间部分-->
	<div id='mainDiv'>
		<!--用户登录相关信息-->
		<input type="hidden" id="user" name="user" th:value="${user}">
		<input type="hidden" id="pass" name="pass" th:value="${pass}">
		<input type="hidden" id="webserverip" name="webserverip" th:value="${webserverip}">
		<input type="hidden" id="webserverport" name="webserverport" th:value="${webserverport}">
		<input type="hidden" id="selfimg" name="selfimg" th:value="${selfimg}">
        <input type="hidden" id="userAgent" name="user_agent" th:value="${user_agent}">

		<div id="leftNavi">
			<ul>
				<li id="wsclientChat.page" class="mouseleftclick">聊天<span id="unreadCountSpan"></span></li>
				<li id="/file/musicPlayer.page">音乐播放器</li>
				<!--<li id="addFriends.page">添加好友</li>-->
				<li id="/zhddkk/wsUsers/wsUsers">添加好友</li>
				<!--<li id="friendsList.page">我的好友</li>-->
				<li id="/zhddkk/wsFriends">我的好友</li>
				<!--<li id="myApply.page">我的申请记录</li>-->
				<li id="/zhddkk/wsFriendsApply/myApply">我的申请记录</li>
				<!--<li id="friendsApply.page">好友申请记录</li>-->
				<li id="/zhddkk/wsFriendsApply/friendApply">好友申请记录</li>
				<li id="wsclientCircle.page">朋友圈</li>
				<li id="/game/gameIndex.page">游戏娱乐</li>
				<li id="/canvas/canvasIndex.page">2D游戏</li>
			</ul>
		</div>

		<div id="diffPage" align="center" style="width:1136px;height:100%;float:left;border:2px solid green;margin-left:2px;">
			<iframe id="iframePage" width="1130px" height="605px;"></iframe>
		</div>
	</div>

	<!--迷你音乐播放器-->
	<div id='musicIframeDiv'>
		<div id='musicIframeHeader'>
			<span style='display:inline-block;width:67%;color: black;font-weight: bold;'>&nbsp;&nbsp;按住我拖动&nbsp;&nbsp;</span>
			<button id='resetMusicIframeDivPosBtn' style='display:inline-block;width:30%;color:black;'>复位</button>
		</div>
		<iframe id="musicIframePage" width="100%" height="100%" src="../file/musicPlayerSimple.page"></iframe>
	</div>	
	
	<!--右下角广告页面 -->
	<div id="adDiv" style="position:fixed;bottom:10px;right:10px;width:350px;height:250px;border:3px solid green;background-color:white;over-flow:hidden;display:none">
		<div id="adBtn" style="style:1px solid red;background-color:#5082b9;padding-left:290px">
			<button id="closeAd" class='btn btn-sm btn-primary' onclick="closeAd()">关&nbsp;&nbsp;闭</button>
		</div>
		<div id="adTitle" style="height:30px;text-align:center;font-size:20px;">
		</div>
		
		<div id="adContent" style="height:auto;text-indent:2em;">
		</div>
	</div>

    <!--底部-->
    <div id="footDiv" align="center">
		<div style="height:20px;">
			<div style="float:left;">
				<label id="curUser22">邮箱:547495788@qq.com</label>
			</div>
			<div style="float:left;margin-left: 350px;">
				<label id="cliName">所有版权信息归作者所有</label>
				<label id="versionLabel" style='margin-left:15px;color:blue;font-weight:bold;'></label>
				<a href='javascript:void(0)' onclick='checkUpdate()' style='margin-left:15px;'>检查更新</a>
			</div>
			<div id="copyrightDiv" style="float:right;">
				<ul>
					<li>联系作者 | </li>
					<li>捐赠作者 | </li>
					<li>提出疑问 | </li>
					<li>关于我们</li>
				</ul>
			</div>
		</div>

		<!--提示栏 -->
		<div id="statusDiv" align="right">
			<span id="statusTips"></span>
		</div>
    </div>

    <div th:include="common::footer"></div>
</body>

    <script type="text/javascript">
        var s_user=$('#user').val();
        var s_pass=$('#pass').val();
        var s_webserverip = $('#webserverip').val();
        var s_webserverport = $('#webserverport').val();
        var s_userAgent = $('#userAgent').val();
        var s_selfimg = $('#selfimg').val();

        //头部头像
        if (s_user == "admin"){
            if (s_selfimg == ""){
                $("#myImg").attr("src",rootUrl+"img/headimg/admin.jpg");
            }else{
                $("#myImg").attr("src", s_selfimg);
            }
        }else{
            $("#myImg").attr("src", s_selfimg);
        }

        //当前时间
        var curTimeTemp = getCurrentTime();
        $("#curTimeSpan").text(curTimeTemp);

        //定时更新时间
        setInterval(function(){
            var curTime = getCurrentTime();
            $("#curTimeSpan").text(curTime);
        },1000)

		//返回登录页
        function toIndex(){
            window.location.href = rootUrl;
        }

        //手机登录
        $("#showQRCodeBtn").click(function(){
            var imgSrc = $("#qrcodeImg").attr("src");
            if (imgSrc == "" || imgSrc == undefined){
                $.ajax({
                    type: 'POST',
                    url: rootUrl+'ws/showQRCode.do',
                    //dataType: 'json',
                    async:false,
                    success: function(result) {
                        $("#qrDiv").css("display","block");
                        $("#qrcodeImg").css("display","block");
                        $("#qrcodeImg").attr("src",result);
                    }
                });
            }else{
                $("#qrcodeImg").attr("src","");
                $("#qrDiv").css("display","none");
                $("#qrcodeImg").css("display","none");
            }
        });

        // 默认显示页:聊天窗口首页
        var cur_pageid = "wsclientChat.page";
        showPage(cur_pageid);
        function showPage(pageId) {
			var url = pageId + "?user="+s_user;
			if (pageId.indexOf("gameIndex.page") != -1){
				window.location.href=pageId;
			}else if (pageId.indexOf("canvasIndex.page") != -1) {
				window.location.href = pageId;
			}else{
				$("#iframePage").attr("src", url);
			}
        }

        //左侧导航栏点击事件
        $("#leftNavi ul li").click(function (){
            cur_pageid = this.id;
            showPage(cur_pageid);
            $("#leftNavi ul li").removeClass("mouseleftclick");
            $(this).addClass("mouseleftclick");
        })

		//左侧导航栏鼠标滑过事件
        $("#leftNavi ul li").hover(function(){
            $(this).removeClass("mousemoveout");
            $(this).removeClass("mousemoveon");
            $(this).addClass("mousemoveon");
        },function(){
            //$(this).css({"background-color":"white","color":"black"});
            $(this).removeClass("mousemoveout");
            $(this).removeClass("mousemoveon");
            $(this).addClass("mousemoveout");
        });


        // ---------------------------------以下是供聊天用的全局变量-----------------------
        var webSocket = null;
        // 连接状态 0:未连接 1:已连接
        var connectStatus = "0"
		//重试连接服务器次数
        var checkCount = 1;
        //最大连接次数
        var checkMaxCount = 20;
        //连接服务器定时器
        var checkTimer = undefined;

        //所有聊天记录
        var chatRecord="";
        //未读消息条数
        var unreadCount=0;

        function updateChatMsg(msg,color,fontSize){
        	var newMsg = "<p style='color:"+color+";font-size:"+fontSize+"px;line-height:14px;'>["+getCurrentTime()+"] [系统信息] "+msg+"</p>";
			var msgFromServerObj = getIframeElement("msgFromServer");
			var textArea = $(msgFromServerObj).append(newMsg);
			chatRecord = chatRecord + newMsg;
			showTips(msg, color);
        }

        //连接服务器
        function checkConnection() {
            if (connectStatus == "0") {
                if (checkCount >= checkMaxCount) {
                    if (checkTimer != null && checkTimer != "" && checkTimer != undefined) {
                    	//达到最大连接数后关闭定时器
                        clearInterval(checkTimer);
                    }
                }
                var tempMsg = "正在连接服务器" +s_webserverip+":"+s_webserverport + " [ "+checkCount +" ]"+ "次 请稍等...";
				updateChatMsg(tempMsg, "red", 10);
                checkCount++;
            }else{
                if (checkTimer != undefined){
                	//如果已连上服务器,则清除定时器
                    clearInterval(checkTimer);
                }
            }
        }

        //定时检查连接
        checkTimer = setInterval(function(){
            checkConnection();
        },1000);

        //检查连接
        checkConnection();
        //登录服务器
        loginServer();

        function loginServer() {
            if (webSocket == null) {
                var socketUrl = "ws://"+s_webserverip+":"+s_webserverport+"/zhddWebSocket/" + s_user+"/"+s_pass+"/"+s_userAgent;
                webSocket = new WebSocket(socketUrl);
                webSocket.onerror = function(event){
                    onError(event);
                };
                webSocket.onclose = function(event){
                    OnClose(event);
                };
                webSocket.onopen = function(event){
                    onOpen(event);
                };
                webSocket.onmessage = function(event){
                    onMessage(event);
                };
            }
        }

        //连接成功
        function onOpen(event){
			updateChatMsg("已连上服务器!", "green", 10);
			connectStatus = "1";
        }

        //连接失败
        function onError(event){
			updateChatMsg("连接服务器异常!", "red", 10);
            connectStatus = "0";
            webSocket = null;
        }

        //连接关闭
        function OnClose(event){
			updateChatMsg("客户端已断开!", "red", 10);
            connectStatus = "0";
            stop();
        }

        //接收消息
        function onMessage(event){
			var jsonObj = JSON.parse(event.data);

			var curTime = jsonObj.curTime;
			var msgFrom = jsonObj.from;
			var msgTo = jsonObj.to;
			var typeId = jsonObj.typeId;
			var typeDesc = jsonObj.typeDesc;
			var msg = jsonObj.msg;

            var showStr="["+curTime+"] ["+typeDesc+"] ["+msgFrom+"-->"+msgTo+"] "+msg;
            var defaultCss = "color:red;font-size:10px;line-height:14px;"
            if (typeId == 1) {
                //系统消息
                defaultCss = "color:red;font-size:10px;line-height:14px;";
                showStr="["+curTime+"] ["+typeDesc+"] " +msg;
            }else if (typeId == 2){
                //在线消息
                defaultCss = "color:green;font-size:10px;line-height:14px;";
                showStr="["+curTime+"] ["+typeDesc+"] ["+msgFrom+"-->我] " +msg;
            }else if (typeId == 3){
                //离线消息
                defaultCss = "color:grey;font-size:10px;line-height:14px;";
                showStr="["+curTime+"] ["+typeDesc+"] [我-->"+msgTo+"] " +msg;
            }else if (typeId == 4){
                //广告消息
                defaultCss = "color:blue;font-size:10px;line-height:14px;";
                var title = msg.split("title:")[1].split(";")[0];
                var content = msg.split("content:")[1];
                showStr="["+curTime+"] ["+typeDesc+"] ["+msgFrom+"-->"+msgTo+"] "+"广告标题:"+title+" 广告内容:"+content;
            }else if (msgTo==s_user){
                defaultCss = "color:green;font-size:10px;line-height:14px;";
            }else if (msgFrom==s_user){
                defaultCss = "color:blue;font-size:10px;line-height:14px;";
            }

            if (cur_pageid != "wsclientChat.page"){
                var htmlData = "<p style='" + defaultCss + "'>"+showStr +"</p>";
                chatRecord = chatRecord + htmlData;
                unreadCount = unreadCount+1;
                $("#unreadCountSpan").text(unreadCount);
            }else{
                var htmlData = "<p style='" + defaultCss + "'>"+showStr +"</p>";
                var msgFromServerObj = getIframeElement("msgFromServer");
                chatRecord = chatRecord + htmlData;
                var textArea = $(msgFromServerObj).append(htmlData);
                textArea.scrollTop(textArea[0].scrollHeight - textArea.height());
            }

            if (typeId == 4){
                var title = msg.split("title:")[1].split(";")[0];
                var content = msg.split("content:")[1];

                $("#adTitle").html(title);
                $("#adContent").html(content);
                $("#adDiv").slideDown(500);
            }
        }

        //断开连接
        function stop() {
            if (webSocket != null) {
                webSocket.close();
                webSocket = null;
                connectStatus = "0";
            }
        }

        //关闭广告窗
        function closeAd(){
            $("#adDiv").slideUp(500);
        }

        function refrshMusic(){
            document.getElementById("musicIframePage").contentWindow.showMusic();
        }

        //获取iframe中的元素
        function getIframeElement(eleName){
            var obj = $("#iframePage").contents().find("#"+eleName);
            return obj;
        }

        $("#resetMusicIframeDivPosBtn").click(adjustMusicWindowPosition);

        function adjustMusicWindowPosition(){
            var headDivHeight = $("#headerDiv").height();
            var mainDivHeight = $("#mainDiv").height();
            var mainDivLeft = $("#mainDiv").offset().left;
            var musicIframeDivHeight=$("#musicIframeDiv").height();
            $("#musicIframeDiv").css("top",headDivHeight+mainDivHeight-musicIframeDivHeight-16);
            $("#musicIframeDiv").css("left",mainDivLeft+3);
        }

        adjustMusicWindowPosition();
        //音乐播放器可拖动代码
        dragPanelMove("#musicIframeHeader","#musicIframeDiv");
        function dragPanelMove(downDiv,moveDiv){
            $(downDiv).mousedown(function (e) {
                var isMove = true;
                var div_x = e.pageX - $(moveDiv).offset().left;
                var div_y = e.pageY - $(moveDiv).offset().top;
                $(document).mousemove(function (e) {
                    if (isMove) {
                        var obj = $(moveDiv);
                        obj.css({"left":e.pageX - div_x, "top":e.pageY - div_y});
                    }
                }).mouseup(
                    function () {
                        isMove = false;
                    });
            });
        }

        //窗口大小变化事件
        $(window).resize(function () {
            adjustMusicWindowPosition();
        });

		function showTips(msg,color){
			if (color ==null || color== undefined){
				color="black";
			}
			$("#statusTips").css("color",color);
			$("#statusTips").html(msg);
		}

		$("#setPersonInfoBtn").click(function () {
			layer.open({
				type: 2,
				title: '设置个人信息',
				shadeClose: true,
				shade: 0.8,
				area: ['390px', '500px'],
				content: '/zhddkk/wsUsers/setPersonalInfo.page?user='+s_user
			});
		});

		//底部
        var curVersion = "";
        queryVersion();
        function queryVersion(){
            $.ajax({
                type: 'GET',
                url: rootUrl+'ws/queryVersion.json',
                //dataType: 'json',
                async:false,
                success: function(result) {
                    curVersion = result;
                    $("#versionLabel").text(result);
                }
            });
        }

        function checkUpdate(){
            $.ajax({
                type: 'GET',
                url: rootUrl+'ws/checkUpdate.do?version='+curVersion+"&cmd=check",
                //dataType: 'json',
                async:false,
                success: function(result) {
                    console.log("checkUpdate result:"+result);
                    //needUpdate:false;from:1.0;to:2.0
                    var needUpdate = result.split("needUpdate:")[1].split(";")[0];
                    if (needUpdate == "true"){
                        var toVersion = result.split("to:")[1];

                        layer.confirm('已经发现新版本,是否要升级到'+toVersion+"?", {
                            btn: ['是','否'] //按钮
                        }, function(index){
                            console.log("开始升级到"+toVersion);
                            toUpdate(curVersion);
                            layer.close(index);
                        }, function(index){
                            layer.close(index);
                        });
                    }else{
                        layer.alert('已经是最新版本!');
                    }
                }
            });
        }

        function toUpdate(curVersion){
            $.ajax({
                type: 'GET',
                url: rootUrl+'ws/checkUpdate.do?version='+curVersion+"&cmd=update",
                //dataType: 'json',
                async:false,
                success: function(result) {
                    console.log("升级结果:"+result)
                }
            });
        }

        //定时获取天气
		grapWeatherInfo();
		setInterval(function(){
			grapWeatherInfo();
		},10000);
		function grapWeatherInfo(){
			$.ajax({
				type: 'GET',
				url: rootUrl+'index/grapWetherInfo',
				async:false,
				success: function(result) {
					if (result.code == 0){
						$("#weatherInfo").text(result.data.remark);
						$("#lastUpdateTime").text(result.data.lastUpdateTime);
						$("#location").text(result.data.location);
					}
				}
			});
		}

		//定时切换header标题
		setInterval(function () {
			var titleStatus = $("#headerTitleDiv").css("display");
			if (titleStatus == "none"){
				$("#headerTitleDiv").css("display", "block");
				$("#weatherDiv").css("display", "none");
			}else{
				$("#headerTitleDiv").css("display", "none");
				$("#weatherDiv").css("display", "block");
			}
		},8000);

		//定时滚动header背景图片
		var backgroundPosY = 0;  //max -690
		var downFlag = true;
		setInterval(function () {
			if (downFlag) {
				backgroundPosY -= 1;
			}
			if (!downFlag){
				backgroundPosY += 1;
			}
			if (backgroundPosY <= -690){
				downFlag = false;
			}
			if (backgroundPosY >=0 ){
				downFlag = true;
			}
			$("#headerDiv").css("background-position","0px "+backgroundPosY+"px");
		},10);

		//定时滚动左侧导航栏背景图片
		var backgroundPosX = 0; //max -848
		var leftFlag = true;
		setInterval(function () {
			if (leftFlag) {
				backgroundPosX -= 1;
			}
			if (!leftFlag){
				backgroundPosX += 1;
			}
			if (backgroundPosX <= -848){
				leftFlag = false;
			}
			if (backgroundPosX >=0 ){
				leftFlag = true;
			}
			$("#leftNavi").css("background-position",backgroundPosX+"px -222px");
		},10);
    </script>
</html>
