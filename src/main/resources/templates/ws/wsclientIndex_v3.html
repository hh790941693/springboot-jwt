<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">
<head>
    <title></title>
    <link rel="stylesheet" type="text/css" th:href="@{/js/easyui-1.9.11/themes/default/easyui.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/js/easyui-1.9.11/themes/icon.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/js/easyui-1.9.11/css/default.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/js/plugins/layui/css/layui.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/js/fontAwesome/css/font-awesome.css}">
    <script type="text/javascript" th:src="@{/js/easyui-1.9.11/jquery.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/easyui-1.9.11/jquery.easyui.min.js}"></script>
    <script type="text/javascript" th:src='@{/js/easyui-1.9.11/locale/easyui-lang-zh_CN.js}'> </script>
    <script type="text/javascript" th:src='@{/js/easyui-1.9.11/indexFramework.js}'> </script>
    <script type="text/javascript" th:src="@{/js/vue/vue.min.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery/rootPath.js}"></script>
    <script type="text/javascript" th:src="@{/js/common/common.js}"></script>
    <script type="text/javascript" th:src="@{/js/layer/layer.js}"></script>
    <script type="text/javascript" th:src="@{/js/jquery/jquery.i18n.properties.js}"></script>
    <script type="text/javascript" th:src="@{/js/plugins/layui/layui.all.js}"></script>
    <th:block th:include="common :: sessionInfo"></th:block>

    <style type="text/css">
        #musicIframeDiv {
            position: fixed;
            width: 168px;
            height: 118px;
            left: 0px;
            bottom: 150px;
            z-index: 99;
            border: 1px solid #8DB2E3;
            display: none;
        }

        #musicIframeHeader {
            background: #ddd;
            cursor: move;
            font-size: 10px;
        }
        
        #weatherDiv label {
            font-size: 14px;
        }

        #headerTitleDiv label {
            font-size: 25px;
        }

        .tb{
            width:100%;
            margin:0;
            padding:5px 4px;
            border:1px solid #ccc;
            box-sizing:border-box;
        }

        .l-btn-icon-left .l-btn-text {
            margin: 0 2px 0 23px;
        }

        .l-btn-text {
            display: inline-block;
            vertical-align: top;
            width: auto;
            line-height: 24px;
            font-size: 11px;
            padding: 0;
            margin: 0 6px;
        }

        #northDiv {
            overflow: hidden; height: 67px;
            background: url(/js/easyui-1.9.11/images/layout-browser-hd-bg.gif) #7f99be repeat-x center 50%;
            line-height: 20px;
            color: #fff;
            font-family: Verdana, 微软雅黑,黑体;
        }

        #northDiv .panel-body {
            background-color: transparent;
            color: white;
        }
        
        #recentNewsPanel ul li {
            list-style: none;
            font-size: 17px;
            margin-bottom: 5px;
        }
    </style>
</head>

<body class="easyui-layout" style="overflow-y: hidden"  scroll="no">
    <!--网页北部区域：头像、时间等信息-->
    <div id="northDiv" region="north" split="false" border="true">

            <div class="easyui-layout" data-options="fit:true">
                <!--左侧-->
                <div data-options="region:'west',split:false,border:false" style="width:178px;">
                    <div class="easyui-layout" data-options="fit:true">
                        <!--左侧头像-->
                        <div data-options="region:'west',split:false,border:false" style="width:62px;padding:1px;">
                            <img id="headImage" th:src="${session.sessionInfo.selfImg}" width="100%" height="100%">
                        </div>
                        <!--右侧-->
                        <div data-options="region:'center',split:false,border:false">
                            <div class="easyui-layout" data-options="fit:true" border="false">
                                <!--登陆用户-->
                                <div data-options="region:'north',split:false,border:false" style="height:35%;padding: 1px 0 0 5px;overflow: hidden;">
                                    <span th:text="${session.sessionInfo.user}" style="font-size: 23px;"></span>
                                </div>
                                <!--角色名-->
                                <div data-options="region:'center',split:false,border:false" style="height:28%;padding: 1px 0 0 5px;margin-left: -7px;overflow: hidden;">
                                    【<span th:text="${session.sessionInfo.roleName == '' ? '尚无角色' : session.sessionInfo.roleName}" style="font-size: 13px;"></span>】
                                </div>
                                <!--在线用户数、积分数-->
                                <div data-options="region:'south',split:false,border:false" style="height:37%;padding: 5px 0 0 5px;overflow: hidden;">
                                      <span class="icon icon-11-19" th:title="#{span.onlinecount.tips}"></span>
                                      <label id="onlineNum">0</label>&nbsp;&nbsp;
                                      <span class="icon icon-22-3" th:title="#{span.coinnum.tips}"></span>
                                      <label id="coinNum">0</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!--中间部分-->
                <div data-options="region:'center',split:false,border:false" style="text-align: center;">
                    <div id="headerTitleDiv" style="height:100%;font-size:20px;padding-top:20px;display: block;">
                        <label id="titleLabel" style="color:white;">websocket客户端</label>
                    </div>
                </div>
                
                <!--右侧-->
                 <div data-options="region:'east',split:false,border:false" style="width:520px">
                        <div class="easyui-layout" data-options="fit:true">
                            <!--右侧时间-->
                            <div data-options="region:'north',split:false,border:false" style="height:40%;padding-top:4px;">
                                <div class="easyui-layout" data-options="fit:true">
                                    <!--天气-->
                                    <div data-options="region:'west',split:false,border:false" style="width:340px;text-align: center;">
                                        <div id="weatherDiv" style="height:100%;padding-top:1px;display: block;">
                                            <label id="weatherInfo" style="color:white;"></label>&nbsp;&nbsp;
                                            <label id="lastUpdateTime" style="color:white;"></label>&nbsp;&nbsp;
                                            <label id="location" style="color:white;"></label>
                                        </div>
                                    </div>
                                    <!--时间-->
                                     <div data-options="region:'center',split:false,border:false" style="text-align: right;padding-right: 5px;">
                                        <span id="curTimeSpan" style="font-size:14px;color: white;">0000-00-00 00:00:00</span>
                                    </div>
                                </div>
                            </div>

                            <!--右侧按钮组-->
                            <div data-options="region:'center',split:false,border:false" style="height:60%;padding-top: 4px;text-align: right;padding-right: 5px;">
                                <a href="#" class="easyui-linkbutton" data-options="iconCls:'icon icon-15-1'" id="playMusicBtn">音乐播放</a>
                                <a href="#" id="signBtn" class="easyui-linkbutton" data-options="iconCls:'icon icon-7-20'">每日签到&nbsp;&nbsp;</a>
                                 <a href="#" id="qrcodeBtn" class="easyui-linkbutton" data-options="iconCls:'icon icon-14-13'">手机登录&nbsp;&nbsp;</a>
                                <a href="#" id="settingBtn" class="easyui-linkbutton" data-options="iconCls:'icon icon-6-2'">个人设置&nbsp;&nbsp;</a>
                                <a href="#" id="modifyPasswordBtn" class="easyui-linkbutton" data-options="iconCls:'icon icon-12-20'">修改密码&nbsp;&nbsp;</a>
                                <a href="#" id="loginOutBtn" class="easyui-linkbutton" data-options="iconCls:'icon icon-9-12'">安全退出&nbsp;&nbsp;</a>
                            </div>
                        </div>
                 </div>
            </div>
    </div>
    
    <!--网页南部区域：网页底部，版权等信息-->
    <div region="south" split="false" style="height: 48px; background: #D2E0F2;">
        <div class="footer" style="height:100%;">
            <div style="height:50%;">
                <div style="width:30%;float:left;text-align:left;">
                    <span>COPYRIGHT 2019 – 2030 版权归作者所有，侵权必究 1.0-Snapshot</span>
                </div>

                <div style="width:38%;float:right;text-align:right;">
                    <a href="#" id="sessionInfoBtn">
                        <span class="icon icon-11-3"></span>会话信息&nbsp;
                    </a>
                    <a href="#" id="contactBtn">
                        <span class="icon icon-22-16"></span>联系作者&nbsp;
                    </a>&nbsp;
                    <a href="#" id="donateBtn">
                        <span class="icon icon-14-18"></span>捐赠&nbsp;
                    </a>&nbsp;
                    <a href="#" id="feedbackBtn">
                        <span class="icon icon-12-9"></span>反馈建议&nbsp;
                    </a>&nbsp;
                    <a href="#" id="aboutUsBtn">
                        <span class="icon icon-12-11"></span>关于我们&nbsp;
                    </a>
                </div>
            </div>

            <!--底部提示信息-->
            <div style="height:50%;text-align:right;">
                <span id="bottomSpanTips"></span>
            </div>
        </div>
    </div>
    
    <!--网页西部区域：菜单导航-->
    <div region="west" split="false" title="导航菜单" style="width:180px;" id="west">
        <div class="easyui-accordion" fit="true" border="false">
            <!--  导航内容 -->
        </div>
    </div>
    
    <!--网页中间区域：内容部分-->
    <div id="mainPanle" region="center" style="background: #eee; overflow-y:hidden">
        <div region="north" split="false" title="内容部分" id="centerDiv" style="height:calc(100% - 20px);width:100%;">
            <div id="tabs" class="easyui-tabs"  fit="true" border="false" style="height:100%;width:100%;">
                <div title="首页" data-options="iconCls:'icon icon-12-11',closable:false" style="padding:20px;overflow:hidden;" id="home">
                    <div class="easyui-layout" data-options="fit:true">
                        <div data-options="region:'west',collapsed:false,split:false,border:true,title:'最新动态',iconCls:'icon icon-13-4'" style="width:30%;">
                            <div id="recentNewsPanel" style="width:100%;height:200px;padding: 10px 0 0 10px;">
                                <ul>
                                </ul>
                            </div>
                        </div>
                        
                         <div data-options="region:'center',split:false,border:true,title:'娱乐区',iconCls:'icon icon-13-16',tools:'#gameTool'" style="overflow: hidden;">
                             <iframe id="gameIframe" scrolling="auto" frameborder="0" src="../canvas/trafficByCanvas-smooth-0624.page" style="width:100%;height:100%;"></iframe>

                             <div id="gameTool">
                                 <a href="javascript:void(0)" title="换一个" class="fa fa-refresh" onclick="changeGame()"></a>
                             </div>
                         </div>
                        
                         <div id="myFriendsDiv" data-options="region:'east',collapsed:true,split:false,border:true,title:'好友列表',iconCls:'icon icon-11-19'" style="width:260px;padding: 10px;display: none;">
                            <!--右侧好友列表-->
                            <div style="width: 100%;height:100%;border:2px solid green;background-color: white;">
                                <div id="friendsListDiv" style="width: 100%;height: 100%;">
                                    <div style="width:100%;height:25px;background-color: #365e71;color:white;">
                                        <span>我的好友</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                        <span>{{onlineFriendCount}}/{{friendList.length}}</span>
                                    </div>
                                    <div style="width:100%;height:calc(100% - 25px);overflow-y: scroll;padding:3px;">
                                        <div v-for="row in friendList" style="width:100%;height:50px;margin-bottom: 8px;">
                                            <div style="width:26%;height:50px;float: left;">
                                                <img :src="row.headImage" width="100%" height="100%"
                                                     onerror="this.onerror='';this.src=$.ws.errorImgUrl">
                                            </div>
                                            <div style="width:67%;height:50px;float:left;margin-left: 5px;">
                                                <div>
                                                    <template v-if="row.state == '0'">
                                                        <p style="font-size: 14px;color:grey;cursor: pointer;"
                                                           @click="showPersonInfo(row.name)">{{row.name}}</p>
                                                    </template>
                                                    <template v-else>
                                                        <p style="font-size: 14px;color: red;cursor: pointer;"
                                                           @click="showPersonInfo(row.name)">{{row.name}}</p>
                                                    </template>
                                                    <p style="font-size: 12px;">{{row.lastLoginTime}}</p>
                                                </div>
                                                <div>
                                                    <span style="font-size: 12px;">{{row.sign}}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div region="south" split="false" title="滚动消息" style="width: 100%;height:20px;background-color: white;border-top: 1px solid #8DB2E3;">
            <marquee direction="left" scrolldelay="10" scrollamount="7" onMouseOver="this.stop()" onMouseOut="this.start()">
                <span id="adsSpan"></span>
            </marquee>
        </div>
    </div>
    
    <!--修改密码窗口 默认不显示-->
    <div id="modifyPasswordDiv" class="easyui-window" title="修改密码" collapsible="false" minimizable="false"
         maximizable="false" data-options="iconCls:'icon-save'" closed="true" style="width: 300px; height: 160px; padding: 1px;display: none;">
        <div class="easyui-layout" fit="true">
            <div region="center" border="true" style="padding: 10px;">
                <table cellpadding=3 style="border-collapse:separate; border-spacing:10px;">
                    <tr>
                        <td>用户名：</td>
                        <td><input name="user" type="text" class="txt01 easyui-validatebox tb" readonly th:value="${session.sessionInfo.user}"/></td>
                    </tr>
                    <tr>
                        <td>旧密码：</td>
                        <td><input name="oldPass" type="password" class="txt01 easyui-validatebox tb" data-options="required:true"/></td>
                    </tr>
                    <tr>
                        <td>新密码：</td>
                        <td><input id="newPass" name="newPass" type="password" class="txt01 easyui-validatebox tb" data-options="required:true"/></td>
                    </tr>
                    <tr>
                        <td>确认密码：</td>
                        <td><input id="confirmPass" name="confirmPass" type="password" class="txt01 easyui-validatebox tb" required="required" validType="equals['#newPass']"/></td>
                    </tr>
                </table>
            </div>
            <div region="south" border="false" style="text-align: right; height: 36px; line-height: 30px;">
                <a class="easyui-linkbutton" icon="icon-ok" href="javascript:void(0)" onclick="modifyPassword()">确定</a>
                <a class="easyui-linkbutton" icon="icon-cancel" href="javascript:void(0)" onclick="cancel()">取消</a>
            </div>
        </div>
    </div>

    <!--tab框区域右键菜单栏 默认不显示-->
    <div id="mm" class="easyui-menu" style="width:150px;display: none;">
        <div id="mm-tabclose">关闭</div>
        <div id="mm-tabcloseall">全部关闭</div>
        <div id="mm-tabcloseother">除此之外全部关闭</div>
        <div class="menu-sep"></div>
        <div id="mm-tabcloseright">当前页右侧全部关闭</div>
        <div id="mm-tabcloseleft">当前页左侧全部关闭</div>
        <div class="menu-sep"></div>
        <div id="mm-exit">退出</div>
    </div>

    <!--右上角 二维码 默认不显示-->
    <div id="qrDiv" style="display:none;position: fixed;right: 5px;top: 90px;width: 180px;height: 180px;">
        <img id="qrcodeImg" style="width: 160px;height: 160px;">
    </div>

    <!--左下角 迷你音乐播放器 默认不显示-->
    <div id='musicIframeDiv'>
        <div id='musicIframeHeader'>
            <span style='display:inline-block;width:67%;color: black;font-weight: bold;'>&nbsp;&nbsp;按住我拖动&nbsp;&nbsp;</span>
            <button id='resetMusicIframeDivPosBtn' style='display:inline-block;width:30%;color:black;'>复位</button>
        </div>
        <iframe id="musicIframePage" scrolling="auto" frameborder="0" width="100%" style="height:calc(100% - 17px);" src="/file/musicPlayerSimple.page"></iframe>
    </div>
    
    <!--右下角 广告页面(隐藏) -->
    <div id="adDiv"
         style="position:fixed;bottom:60px;right:10px;width:350px;height:250px;border:3px solid green;background-color:white;over-flow:hidden;display: none;">
        <div id="adBtn" style="style:1px solid red;background-color:#5082b9;padding-left:290px">
            <button id="closeAd" class='btn btn-sm btn-primary' onclick="closeAd()">关&nbsp;&nbsp;闭</button>
        </div>
        <div id="adTitle" style="height:30px;text-align:center;font-size:20px;">
        </div>

        <div id="adContent" style="height:auto;text-indent:2em;">
        </div>

        <div id="adTime"
             style="height:15px;font-size: 16px;font-weight: bold;position: absolute;right:2px;bottom: 3px;">
        </div>
    </div>
</body>

<script type="text/javascript">
    // 左侧导航菜单
    var _menus = {
        "menus":[]
    };

    // 获取左侧导航栏菜单列表
    $.ajax({
        type: 'GET',
        url: rootUrl + '/zhddkk/sysMenu/getRoleMenuList?userId=' + sessionUserId,
        async: false,
        dataType: 'json',
        success: function (result) {
            if (result.code == 1) {
                _menus.menus = result.data;
            }
        }
    });

    //获取在线人数和积分数量
    var onlineData = {};
    $.ajax({
        type: 'GET',
        url: 'ws/getOnlineInfo.json',
        async: false,
        data: {"user": sessionUser},
        //dataType: 'json',
        success: function (result) {
            if (result.code != 1) {
                return;
            }
            onlineData = result.data;
            var currentUserOnlineInfo = onlineData.currentOnlineUserInfo;
            var coinNum = currentUserOnlineInfo.coinNum;
            var onlineNum = onlineData.onlineUserList.length;
            var headImage = currentUserOnlineInfo.headImage;

            // 左上角头像、积分、在线人数
            $("#coinNum").text(coinNum);
            $("#onlineNum").text(onlineNum);
            if (headImage == null || headImage == "") {
                $("#headImage").attr("src", rootUrl + "../img/" + $.ws.errorImageName);
            } else {
                $("#headImage").attr("src", headImage);
            }
        }
    });

    
    $(function() {
        console.log("主页获取session数据:" + sessionUser);
        // 修改地址栏地址,不显示多余的参数或者页面信息
        history.replaceState(null, null, "/");

        // 修改密码对话框
        $('#modifyPasswordDiv').window({
            title: '修改密码',
            width: 300,
            modal: true,
            shadow: true,
            closed: true,
            height: 260,
            resizable:false
        });

        // 设置网页标题
        setPageTitle();
        function setPageTitle() {
            var title = "";
            if (sessionRoleId == "1") {
                title = "page.serverindex.title";
            } else {
                title = "page.clientindex.title";
            }
            $("title").text($.ws.i18n(title));
        }

        //定时获取天气
        grapWeatherInfo();
        function grapWeatherInfo() {
            $.ajax({
                type: 'GET',
                url: rootUrl + 'index/grapWetherInfo',
                async: false,
                success: function (result) {
                    if (result.code == 1) {
                        $("#weatherInfo").text(result.data.remark);
                        $("#lastUpdateTime").text(result.data.lastUpdateTime);
                        $("#location").text(result.data.location);
                    }
                }
            });
        }

        //定时切换header标题
        var headerTitle = $.ws.i18n("web.title");
        $("#titleLabel").text(headerTitle);

        //定时更新时间
        setInterval(function () {
            var curTime = getCurrentTime();
            $("#curTimeSpan").text(curTime);
        }, 1000);

        // 音乐播放
        $("#playMusicBtn").click(function (){
            var displayStatus = $("#musicIframeDiv").css("display");
            if (displayStatus == "none") {
                $("#musicIframeDiv").css("display", "block");
            } else {
                $("#musicIframeDiv").css("display", "none");
            }
        });

        // 每日签到
        $("#signBtn").click(function() {
            $.ajax({
                type: 'POST',
                url: '/zhddkk/wsSign/sign',
                data: {"user": sessionUser},
                async: false,
                success: function (result) {
                    layer.msg(result.msg);
                }
            });
        });

        // 手机登录
        $("#qrcodeBtn").click(function() {
            var imgSrc = $("#qrcodeImg").attr("src");
            if (imgSrc == "" || imgSrc == undefined) {
                $.ajax({
                    type: 'POST',
                    url: '/showQRCode.do',
                    //dataType: 'json',
                    async: false,
                    success: function (result) {
                        $("#qrDiv").css("display", "block");
                        $("#qrcodeImg").css("display", "block");
                        $("#qrcodeImg").attr("src", result);
                    }
                });
            } else {
                $("#qrcodeImg").attr("src", "");
                $("#qrDiv").css("display", "none");
                $("#qrcodeImg").css("display", "none");
            }
        });

        // 设置
        $("#settingBtn").click(function() {
            layer.open({
                type: 2,
                title: '设置个人信息',
                shadeClose: true,
                shade: 0.2,
                area: ['540px', '580px'],
                anim: 1,
                content: '/zhddkk/wsUsers/setPersonalInfo.page?user=' + sessionUser
            });
        });

        // 修改密码
        $("#modifyPasswordBtn").click(function (){
            $('#modifyPasswordDiv').window('open');
        })

        // 退出
        $("#loginOutBtn").click(function() {
            $.messager.confirm('退出', '确认退出吗?', function(r){
                if (r){
                    $.ajax({
                        type: 'POST',
                        url: 'ws/logout.do',
                        data: {"user": sessionUser},
                        async: false,
                        success: function (result) {
                            top.location.href = rootUrl;
                        }
                    });
                }
            });
        });

        // 会话信息
        $("#sessionInfoBtn").click(function() {
            layer.open({
                type: 2,
                title: '会话信息',
                maxmin: false,
                shadeClose: true,//点击遮罩关闭层
                area: ['630px', '450px'],
                anim: 1,
                content: '/sessionInfo.page'
            });
        });

        // 联系作者
        $("#contactBtn").click(function() {
            layer.open({
                type: 2,
                title: '联系作者',
                maxmin: false,
                shadeClose: true,//点击遮罩关闭层
                area: ['530px', '300px'],
                anim: 1,
                content: 'index/contactAuthor.page'
            });
        });

        //捐赠作者
        $("#donateBtn").click(function() {
            layer.open({
                type: 2,
                title: '捐赠作者',
                maxmin: false,
                shadeClose: true,//点击遮罩关闭层
                area: ['530px', '300px'],
                anim: 1,
                content: 'index/donate.page'
            });
        });

        //提出疑问
        $("#feedbackBtn").click(function() {
            parent.layer.open({
                type: 2,
                title: '提出疑问',
                maxmin: false,
                shadeClose: true,//点击遮罩关闭层
                area: ['530px', '300px'],
                anim: 1,
                content: 'index/feedbackUs.page'
            });
        });

        //关于我们
        $("#aboutUsBtn").click(function() {
            parent.layer.open({
                type: 2,
                title: '关于我们',
                maxmin: false,
                shadeClose: true,//点击遮罩关闭层
                area: ['530px', '300px'],
                anim: 1,
                content: 'index/aboutUs.page'
            });
        });

        // 简易音乐播放器复位
        $("#resetMusicIframeDivPosBtn").click(adjustMusicWindowPosition);
        function adjustMusicWindowPosition() {
            $("#musicIframeDiv").css("bottom", "150px");
            $("#musicIframeDiv").css("left", "1px");
        }
        //音乐播放器可拖动代码
        $.ws.dragPanelMove("#musicIframeHeader", "#musicIframeDiv");

        // 首页--我的好友列表
        var app = new Vue({
            el: '#friendsListDiv',
            data: {
                friendList: {},
                loginUser: sessionUser,
                onlineFriendCount: 0,
                offlineFriendCount: 0,
                friendList: onlineData.friendsList,
                onlineFriendCount: onlineData.onlineFriendCount,
                offlineFriendCount: onlineData.offlineFriendCount,
            },
            methods: {
                showPersonInfo: function (userName) {
                    layer.open({
                        type: 2,
                        title: '用户个人信息',
                        shadeClose: true,
                        shade: 0.2,
                        area: ['390px', '420px'],
                        content: '/zhddkk/wsUsers/showPersonalInfo.page?user=' + userName
                    });
                }
            },
            created: function (e) {
                // do nothing
            }
        });

        //获取最新广告
        queryRecentAdsList();
        function queryRecentAdsList() {
            $.ajax({
                type: 'GET',
                url: '/zhddkk/wsAds/queryRecentAdsList?count=5',
                async: false,
                success: function (result) {
                    if (result.code == 1) {
                        var totalAds = "";
                        var data = result.data;
                        if (data.length == 0) {
                            totalAds = "&lt;span style='font-weight: bold;font-size:14px;color:red;'>暂无消息&lt;/span>";
                        } else {
                            $.each(data, function (i, val) {
                                // 首页底部滚动消息用
                                var spanHtml = "<span><a style='color:blue;font-weight: bold;' onclick='showAdsDetail(" + val.id + ")'>【查看详情】</a></span><span style='font-size:14px;font-weight: bold;'>" + val.title + "</span><span style='font-size:9px;color: grey;margin-left:5px;margin-right: 200px;'>"+val.createTime+"</span>";
                                totalAds += spanHtml;

                                // 首页 左侧 消息列表用
                                var spanHtml2 = "<span><a style='color:blue;font-weight: bold;' onclick='showAdsDetail(" + val.id + ")'>【查看详情】</a></span><span style='font-size:14px;font-weight: bold;'>" + val.title + "</span><span style='font-size:9px;color: grey;margin-left:5px;'>"+val.createTime+"</span>";
                                $("#recentNewsPanel ul").append("<li>"+spanHtml2+"</li>");
                            });
                        }
                        $("#adsSpan").html(totalAds);
                    }
                }
            });
        }
    });

    // 新密码与确认密码是否一致
    $.extend($.fn.validatebox.defaults.rules, {
        equals: {
            validator: function(value,param){
                return value == $(param[0]).val();
            },
            message: '两次密码不一致.'
        }
    });
    
    // 取消修改密码
    function cancel() {
        $('#modifyPasswordDiv').window('close');
    }

    // 修改密码
    function modifyPassword() {
        $.ajax({
            type: 'POST',
            url: '/zhddkk/wsUsers/updatePassword.do',
            data: {"user": sessionUser,
                    "oldPass": $("input[name='oldPass']").val(),
                    "newPass": $("input[name='newPass']").val(),
                    "confirmPass": $("input[name='confirmPass']").val(),
            },
            //dataType: 'json',
            success: function (result) {
                if (result.code == 1) {
                    layer.msg("密码修改成功");
                } else {
                    layer.msg(result.data);
                }
                setTimeout(cancel, 2500);
            }
        });
    }

    /**
     * 查看广告详情页
     * @param adId
     */
    function showAdsDetail(adId) {
        window.open("./zhddkk/wsAds/adsDetail.page?id=" + adId);
    }

    // 首页-中间部分-切换游戏
    function changeGame() {
        var gameList = new Array("../canvas/starts.page","../canvas/clock.page","../canvas/clock2.page"
            ,"../canvas/trafficByCanvas_stepbystep.page","../canvas/trafficByCanvas-smooth-0624.page"
            ,"../canvas/tank_p1p2.page","../canvas/tank_construct.page","../canvas/xiangqi_v6.0.page","../canvas/pintu.page"
            ,"../game/ball.page","../game/plane.page","../game/myrussia.page");
        var gIndex = randomNumber(0, gameList.length);
        var gUrl = gameList[gIndex];
        $("#gameIframe").attr("src", gUrl);
    }

    // ---------------------------------以下是供聊天用的全局变量-----------------------
    var webSocket = null;

    // 连接状态
    var connectStatus = "0";
    //重试连接服务器次数
    var checkCount = 1;
    //最大连接次数
    var checkMaxCount = 20;
    //连接服务器定时器
    var checkTimer = undefined;

    //所有聊天记录
    var chatRecord = "";
    //未读消息条数
    var unreadCount = 0;

    function updateChatMsg(msg, color, fontSize) {
        var newMsg = "<p style='color:" + color + ";font-size:" + fontSize + "px;line-height:14px;'>[" + getCurrentTime() + "] [系统信息] " + msg + "</p>";
        var msgFromServerObj = getIframeElement("msgFromServer");
        var textArea = $(msgFromServerObj).append(newMsg);
        chatRecord = chatRecord + newMsg;
        showTips(msg, color);
    }

    //连接服务器
    function checkConnection() {
        if (connectStatus == "0") {
            if (checkCount >= checkMaxCount) {
                if (checkTimer != null && checkTimer != "" && checkTimer != undefined) {
                    //达到最大连接数后关闭定时器
                    clearInterval(checkTimer);
                }
            }
            updateChatMsg("正在连接服务器" + sessionWebserverIp + ":" + sessionWebserverport + " [ " + checkCount + " ]" + "次 请稍等...", "red", 10);
            checkCount++;
        } else {
            if (checkTimer != null && checkTimer != "" && checkTimer != undefined) {
                clearInterval(checkTimer);
            }
        }
    }

    //定时检查连接
    checkTimer = setInterval(function () {
        checkConnection();
    }, 1000);

    //检查连接
    checkConnection();
    //登录服务器
    loginServer();

    function loginServer() {
        if (webSocket == null) {
            var socketUrl = "ws://" + sessionWebserverIp + ":" + sessionWebserverport + "/zhddWebSocket/" + sessionUser + "/" + sessionPassword + "/" + sessionUseragent;
            webSocket = new WebSocket(socketUrl);
            webSocket.onerror = function (event) {
                onError(event);
            };
            webSocket.onclose = function (event) {
                OnClose(event);
            };
            webSocket.onopen = function (event) {
                onOpen(event);
            };
            webSocket.onmessage = function (event) {
                onMessage(event);
            };
        }
    }

    //连接成功
    function onOpen(event) {
        connectStatus = "1";
        var msg = $.ws.i18n("label.connected");
        updateChatMsg(msg, "green", 10);
    }

    //连接失败
    function onError(event) {
        updateChatMsg("连接服务器异常!", "red", 10);
        connectStatus = "0";
        webSocket = null;
    }

    //连接关闭
    function OnClose(event) {
        updateChatMsg("客户端已断开!", "red", 10);
        connectStatus = "0";
        stop();
    }

    //接收消息
    function onMessage(event) {
        var jsonObj = JSON.parse(event.data);
        var curTime = jsonObj.curTime;
        var msgFrom = jsonObj.from;
        var msgTo = jsonObj.to;
        var typeId = jsonObj.typeId;
        var typeDesc = jsonObj.typeDesc;
        var msg = jsonObj.msg;

        var showStr = "[" + curTime + "] [" + typeDesc + "] [" + msgFrom + "-->" + msgTo + "] " + msg;
        var defaultCss = "color:red;font-size:10px;line-height:14px;"
        if (typeId == 1) {
            //系统消息
            defaultCss = "color:red;font-size:10px;line-height:14px;";
            showStr = "[" + curTime + "] [" + typeDesc + "] " + msg;
        } else if (typeId == 2) {
            //在线消息
            defaultCss = "color:green;font-size:10px;line-height:14px;";
            showStr = "[" + curTime + "] [" + typeDesc + "] [" + msgFrom + "-->" + msgTo + "] " + msg;
        } else if (typeId == 3) {
            //离线消息
            defaultCss = "color:grey;font-size:10px;line-height:14px;";
            showStr = "[" + curTime + "] [" + typeDesc + "] [" + msgFrom + "-->" + msgTo + "] " + msg;
        } else if (typeId == 4) {
            //广告消息
            defaultCss = "color:blue;font-size:10px;line-height:14px;";
            var title = msg.split("title:")[1].split(";")[0];
            var content = msg.split("content:")[1];
            showStr = "[" + curTime + "] [" + typeDesc + "] [" + msgFrom + "-->" + msgTo + "] " + "广告标题:" + title + " 广告内容:" + content;
        } else if (msgTo == sessionUser) {
            defaultCss = "color:green;font-size:10px;line-height:14px;";
        } else if (msgFrom == sessionUser) {
            defaultCss = "color:blue;font-size:10px;line-height:14px;";
        }

        var tabsObj = $('#tabs').tabs('getSelected');
        var selectedTab = tabsObj.panel('options').tab;
        var tabTitle = $(selectedTab).text();
        if (tabTitle != "聊天监控" && tabTitle != "实时聊天") {
            var htmlData = "<p style='" + defaultCss + "'>" + showStr + "</p>";
            chatRecord = chatRecord + htmlData;
            unreadCount = unreadCount + 1;
            //$("#leftNaviIframePage").contents().find("#unreadCountSpan").text(unreadCount);
        } else {
            var htmlData = "<p style='" + defaultCss + "'>" + showStr + "</p>";
            var msgFromServerObj = getIframeElement("msgFromServer");
            chatRecord = chatRecord + htmlData;
            var textArea = $(msgFromServerObj).append(htmlData);
            textArea.scrollTop(textArea[0].scrollHeight - textArea.height());
        }

        if (typeId == 4) {
            var title = msg.split("title:")[1].split(";")[0];
            var content = msg.split("content:")[1];

            $("#adTitle").html(title);
            $("#adContent").html(content);
            $("#adTime").html(curTime);
            $("#adDiv").slideDown(500);
        }
    }

    //获取iframe中的元素
    function getIframeElement(eleName) {
        var obj = $("iframe[name='mainFrame']").contents().find("#" + eleName);
        return obj;
    }

    //断开连接
    function stop() {
        if (webSocket != null) {
            webSocket.close();
            webSocket = null;
            connectStatus = "0";
        }
    }

    //关闭广告窗
    function closeAd() {
        $("#adDiv").slideUp(500);
    }
    
    //footer内的提示语
    function showTips(msg, color) {
        $("#bottomSpanTips").css("color", color);
        $("#bottomSpanTips").html(msg);
    }
</script>
</html>