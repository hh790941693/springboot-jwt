<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="common :: header"></head>
	<title>朋友圈</title>

<style type="text/css">
	*{
		margin:0px;
		padding:0px;
	}
	
	span{
		display:inline-block;
		height:100%;
	}
	
	#mainDiv{
	    width: 100%;
	    height: 100%;
	    padding:5px;
	    background-color:#aaeca812;
	}
	#naviDiv{
	    width: 130px;
	    height: 30px;
	    position: fixed;
	    bottom: 35px;
	    right: 25px;
	}
	
	.nameDivClass{
		background-color:#b3d7ff;
		height:37px;
	}
	
	.userSpanClass{
		width:49%;
		font-size:20px;
		font-weight:bold;
		color:blue;
		cursor:pointer;
	}
	
	.myselfUserSpanClass{
		width:48%;
		font-size:20px;
		font-weight:bold;
		color:green;
		cursor:pointer;
	}

	.commentNameSpanClass{
		color:blue;
		width:65px;
		margin-left:10px;
		cursor:pointer;
	}
	
	.commentDivClass{
		margin-top:2px;
	}
	.commentDivClass p{
		background-color:#d6f3d9;
		margin-bottom:1px;
	}
	
	.contentDivClass{
		letter-spacing:3px;
		font-size:20px;
		margin-bottom:2px;
	}
	
	.timeSpanClass{
	    width: 120px;
    	font-size:13px;
    	color:grey;
    	margin-left:18px;
	}
	
	.likeNumSpanClass{
		color:green;
	    width: 20%;
    	font-size:15px;
	}
	
	.commentSpanClass{
		font-size:15px;
    	width: 73%;
	}
	
	.commentTimeSpanClass{
		color:grey;
		font-size:13px;
		margin-left:30px;
	}
	
	#showBigImageDiv{
	    width: 400px;
	    height: 350px;
	    display: none;
	    position: fixed;
	    top: 130px;
	    left: 350px;
	    z-index:99;
	    border:1px solid black;
	}
	
	.buttonGroupSpan{
		width:170px;
		padding-top: 3px;
	}
	
	.btnDisabledClass{
		background-color:grey;
		color:black;
	}	
</style>
</head>
<body>
	<div id="mainDiv">
		<div id='addCircleDiv' align='right' style='margin-bottom: 5px;'>
			<span>总条数:</span><span id="totalCountSpan"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span>当前第</span><span id='curPageSpan'></span><span>页</span>&nbsp;&nbsp;&nbsp;&nbsp;<span>共</span><span id='totalPageSpan'></span><span>页</span>
			<button onclick='toPrePage()' class='btn btn-sm btn-primary' >&lt;&lt;</button>&nbsp;&nbsp;
			<button onclick='toNextPage()' class='btn btn-sm btn-primary' >&gt;&gt;</button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<button onclick='addCircle()' class='btn btn-sm btn-primary'>&nbsp;&nbsp;发&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;布&nbsp;&nbsp;</button>
		</div>
		<hr/>
		<div id="circleDiv" v-for="(item,index) in circleList">
			<div>
				<div class='bodyDivClass'>
					<div class='nameDivClass'>
						<div style='display:inline-block;height:100%;width:540px;'><img src='{{item.headImg}}' width='30' height='30' onerror='imgerror(this)'>
							<span class='myselfUserSpanClass' onclick='queryPersonInfo(this)'>{{item.userName}}</span></div><span class='likeNumSpanClass'>已有{{item.likeNum}}人点赞</span><span class='buttonGroupSpan'><button onclick='toComment("+circleId+")' class='btn btn-sm btn-primary'>评论</button>&nbsp;&nbsp;&nbsp;<button onclick='toLike("+circleId+")' class='btn btn-sm btn-info'>点赞</button>&nbsp;&nbsp;&nbsp;<button onclick='deleteCircle(item.id)' class='btn btn-sm btn-danger'>删除</button></span><span class='timeSpanClass'>发表于{{item.createTime}}</span>
					</div>
					<div class='contentDivClass'>
						<span>{{item.content}}</span>
					</div>
				</div>
				<div class='picDivClass' align='center'>
					<img src='{{item.pic1}}' width='100px' height='100px' onerror='imgerror(this)' style='margin-left:20px;'>
					<img src='{{item.pic2}}' width='100px' height='100px' onerror='imgerror(this)' style='margin-left:20px;'>
					<img src='{{item.pic3}}' width='100px' height='100px' onerror='imgerror(this)' style='margin-left:20px;'>
					<img src='{{item.pic4}}' width='100px' height='100px' onerror='imgerror(this)' style='margin-left:20px;'>
				</div>

				<div class='commentDivClass' v-for="commentItem in item.commentList">
					<p><span class='commentNameSpanClass' onclick='queryPersonInfo(this)'>{{commentItem.userName}}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='commentSpanClass'>{{commentItem.comment}}</span><a href='javascript:void(0)' onclick='deleteComment(commentItem.id)'>删除</a><span class='commentTimeSpanClass'>发表于{{commentItem.createTime}}</span></p>
				</div>
				<hr/>
			</div>
		</div>
		
		<div id="naviDiv" align="center">
			<button id='preBtn' onclick='toPrePage()' class='btn btn-sm btn-primary' >前一页</button>
			<button id='nextBtn' onclick='toNextPage()' class='btn btn-sm btn-primary' >后一页</button>
		</div>		
	</div>

	<div th:include="common::footer"></div>
</body>

	<script type="text/javascript">
		var curUser=parent.s_user;
		//var curPage = 1;
		//var numPerPage = 5;
		//var totalPage = 0;
		$("#preBtn").hide();
		$("#nextBtn").hide();
		var app = new Vue({
			el: '#mainDiv',
			data: {
				circleList: {},
				curSelectedIndex:0,
				curPage:1,
				numPerPage:5,
			},
			methods: {
				queryCircleList:function (curPagePara,numPerPagePara) {
					$.ajax({
						type: "POST",
						url: rootUrl+'ws/queryCircleByPage.do',
						data: {'curPage':curPagePara, 'numPerPage':numPerPagePara},
						async:false,
						success: function (result) {
							if (result.code == 0){
								return;
							}
							var resultData = result.data;
							app.circleList = resultData.records;
						}
					});
				},
			},
			created: function () {
				this.queryCircleList(1, 5);
			}
		});

		//上一页
		function toPrePage(){
			if (curPage>1){
				curPage = curPage-1;
				queryCirclList(curPage,numPerPage);
			}
		}
		//下一页
		function toNextPage(){
			if (curPage<totalPage){
				curPage = curPage+1;
				queryCirclList(curPage,numPerPage);
			}
		}
		$("#naviDiv").hover(function(){
			$("#preBtn,#nextBtn").show();
		},function(){
			$("#preBtn,#nextBtn").hide();
		})

		//评论
		function toComment(circleId){
			var comment="";
			layer.prompt({
				formType: 2,
				value: '',
				title: '请输入评论内容'
			}, function(value,index){
				comment = value;
				layer.close(index);

				if (comment != ""){
					$.ajax({
						type: 'POST',
						url: rootUrl+'ws/toComment.do',
						//dataType: 'json',
						data:{user:curUser,circleId:circleId,comment:comment},
						async:false,
						success: function(result) {
							if (result.code == 1) {
								layer.msg("评论成功");
								setTimeout(refresh, 800);
							}
						}
					});
				}else{
					alert("评论内容不能为空!");
				}
			});
		}
		//点赞
		function toLike(circleId){
			$.ajax({
				type: 'POST',
				url: rootUrl+'ws/toLike.do',
				//dataType: 'json',
				data:{user:curUser,circleId:circleId},
				async:false,
				success: function(result) {
					if (result.code == 1) {
						layer.msg("点赞成功");
						setTimeout(refresh, 500);
					}
				}
			});
		}
		//删除朋友圈
		function deleteCircle(circleId){
			layer.confirm('确认要删除？', {btn: ['确定','取消']},
				function(){
					$.ajax({
						type: 'POST',
						url: rootUrl+'ws/toDeleteCircle.do',
						//dataType: 'json',
						data:{id:circleId},
						async:false,
						success: function(result) {
							if (result.code == 1) {
								layer.msg("删除成功");
								setTimeout(refresh, 500);
							}
						}
					});
				},
				function(){layer.close();}
			);
		}

		//删除评论
		function deleteComment(commentId){
			layer.confirm('确认要删除？', {btn: ['确定','取消']},
				function(){
					$.ajax({
						type: 'POST',
						url: rootUrl+'ws/toDeleteComment.do',
						//dataType: 'json',
						data:{id:commentId},
						async:false,
						success: function(result) {
							if (result.code == 1) {
								layer.msg("删除成功");
								setTimeout(refresh, 1000);
							}
						}
					});
				},
				function(){layer.close();}
			);
		}

		//新增朋友圈内容
		function addCircle(){
			layer.open({
				type: 2,
				title: '添加朋友圈',
				shadeClose: true,
				shade: 0.8,
				area: ['484px', '490px'],
				content: 'wsclientAddCircle.page?user='+curUser
			});
		}

		//刷新
		function refresh(){
			window.location.href = window.location.href;
		};

		//对img绑定放大事件
		$(".picDivClass img").click(function(){
			$.ws.gShowImg($(this).attr("src"));
		})

		function imgerror(imgObj){
		    var errorImgUrl = rootUrl+"img/"+$.ws.errorImageName;
            console.log("errorImgUrl:"+errorImgUrl);
			$(imgObj).attr("src",errorImgUrl);
		}

		//查看个人信息
		function queryPersonInfo(thisObj){
			var username = $(thisObj).text();
			if (username.indexOf(":")!= -1){
				username = username.replace(":","");
			}
			layer.open({
				type: 2,
				title: '用户个人信息',
				shadeClose: true,
				shade: 0.8,
				area: ['384px', '415px'],
				content: '/zhddkk/wsUsers/showPersonalInfo.page?user='+username
			});
		}
	</script>
</html>
