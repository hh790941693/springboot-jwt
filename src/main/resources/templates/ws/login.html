<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:include="common :: header"></head>
<title>[[#{btn.login}]]</title>
<style type="text/css">
	a{
		font-size:13px;
	}

	a:hover
	{
		font-weight: bold;
		color: #1e88e5;
	}

	body{
		padding-top:270px;
	}

	#mainDiv{
		width:400px;
		height:310px;
		margin:0 auto;
		box-shadow: grey 10px 6px 10px;
		border:1px solid grey;
		position:fixed;
		left:38%;
		top:37%;
		background-repeat: no-repeat;
		background-position: 0px 0px;
	}

	#loginForm{
		padding-left: 40px;
		padding-top: 30px;
	}

	input{
		border: 0;
		outline: none;
		height: 22px;
		text-indent: 0.5em;
	}

	#btnlogin{
		box-shadow: grey 5px 5px 10px;
	}
</style>
</head>
<body>
<div id="mainDiv">
    <input id="locale" type="hidden" th:value="${locale}">
	<div style="height:50px;background-color: #428BCA;padding-top: 5px;">
		<div style="text-align: center;font-size: 35px;color:white;">
			<p>WebSocket</p>
		</div>
	</div>
    <!--二维码登陆-->
	<button id="phonelogin" class='btn btn-info btn-large' style="position:absolute;top:6px;left:6px;font-size: 17px;">
        <span class="glyphicon glyphicon-qrcode"></span>
    </button>
    <!--选择语言-->
    <div style="position:absolute;top:6px;left:323px;">
        <select id="localesSelect" style="height:32px;">
            <option value="zh_cn" th:text="中文" th:selected="${locale == 'zh_cn'}"></option>
            <option value="en_us" th:text="English" th:selected="${locale == 'en_us'}"></option>
            <option value="ko_kr" th:text="한국어" th:selected="${locale == 'ko_kr'}"></option>
        </select>
    </div>
	<img id="backgroundImg" src="../img/fengjing/fj9.jpg" hidden>
	<form id="loginForm" action="wslogin.do" method="post" onsubmit="return checkEnvironment()">
		<div style="height:25px;">
            <span class="glyphicon glyphicon-user" style="font-size: 20px;" for="user"></span>
			<input id="user" name="user" type="text" th:value="${user}" th:placeholder="#{input.user.helper}" autocomplete="off" style="width:178px;margin-left:20px;">
		</div>
		<div style="height:25px;margin-top:10px;">
            <span class="glyphicon glyphicon-lock" style="font-size: 20px;" for="pass"></span>
			<input id="pass" name="pass" type="password" th:value="${pass}" th:placeholder="#{input.password.helper}" autocomplete="off"  style="width:178px;margin-left:20px;">
		</div>
        <div style="height:50px;margin-top:10px;">
            <span class="glyphicon glyphicon-briefcase" style="font-size: 20px;" for="pass"></span>
            <input id="verifyCode" name="verifyCode" type="text" th:value="${verifyCode}" th:placeholder="#{input.code.helper}" autocomplete="off"  style="width:178px;margin-left:20px;">
            <div style="margin-left: 121px;margin-top:5px;">
                <img id="verifyCodeImg"/>
            </div>
        </div>
		<div style="height:25px;margin-top:15px;">
			<a href="javascript:void(0)" onclick="regist()" style="text-decoration:none;margin-left:50px;" th:text="#{a.register.label}"></a>
			<a href="javascript:void(0)" onclick="forgetPassword()" style="text-decoration:none;margin-left:20px;" th:text="#{a.forgetpassword.label}"></a>
			<a href="javascript:void(0)" onclick="openGame(this)" style="text-decoration:none;margin-left:20px;" th:text="#{a.hideh5.label}"></a>
			<a href="javascript:void(0)" onclick="playGame()" style="text-decoration:none;margin-left:20px;" th:text="#{a.playgame.label}"></a>
		</div>

		<div align="center" style="margin-top:10px;margin-left:-30px;">
			<button id="btnlogin" class='btn btn-success btn-large'  type="submit" style="width:100px;">
                <span class="glyphicon glyphicon-log-in"> [[#{btn.login}]]</span>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label><input type="checkbox" value="" checked="checked" id="checkFlag" th:text="#{checkbox.check.label}"></label>
		</div>
	</form>

	<div style="position:absolute;width:180px;height:180px;left:410px;top:1px;">
		<img id="qrImg" style="width:160px;height:160px;display:none">
	</div>
</div>

<div id="checkDiv" style="width:200px;height:400px;position: fixed;left:5px;top:5px;z-index:2;overflow-y: hidden;display: none;">
	<div id="checkContentDiv" style="width:100%;height:auto;border:1px solid grey;background-color: #0C0C0C;padding: 5px 0 5px 10px;">
	</div>
</div>

<div id='canvasDiv' style='position:fixed;left:1px;top:1px;width:100%;height:100%;z-index:-1;'>
	<iframe id="iframePage" width="100%" height="100%" src="/canvas/snow.page"></iframe>
</div>

<div th:include="common::footer"></div>
</body>

<script th:inline="javascript">
	// 加载国际化
	$.ws.i18nInit([[${#locale.language}]], [[${#locale.country}]]);
	console.log($.ws.i18n("btn.login"));

	var user = "";
	var checkBeforeLogin = true;
	var backgroundAnimation = true;
	$("#user").blur(function(){
		user = $("#user").val();
		if (user == ""){
			layer.tips('用户名不能为空!', '#user', {
				tips: [2, '#78BA32']
			});
		}
	})

	var pass = "";
	$("#pass").blur(function(){
		pass = $("#pass").val();
		if (pass == "")
		{
			layer.tips('密码不能为空!', '#pass', {
				tips: [2, '#78BA32']
			});
		}
	});

    var verifyCode = "";
    $("#verifyCode").blur(function(){
        verifyCode = $("#verifyCode").val();
        if (verifyCode == "")
        {
            layer.tips('验证码不能为空!', '#verifyCode', {
                tips: [2, '#78BA32']
            });
        }
    });

	//提交校验
	$("#loginForm").validate({
		rules: {
			user:
                {
                    required: true,
                    minlength: 2,
                    maxlength: 10
                },
			pass:
                {
                    required: true,
                    minlength: 3,
                    maxlength: 12
                },
            verifyCode:
                {
                    required: true,
                    minlength: 1,
                    maxlength: 12
                }
		},
		messages:{
			user:
                {
                    required: "请输入用户名",
                    minlength: "至少包含2个字符",
                    maxlength:"最多包含10位字符"
                },
			pass:
                {
                    required: "请输入密码",
                    minlength: "至少包含3个字符",
                    maxlength:"最多包含12位字符"
                },
            verifyCode:
                {
                    required: "请输入验证码",
                    minlength: "至少包含3个字符",
                    maxlength:"最多包含12位字符"
                },
		}
	});

	//注册账号
	function regist(){
		layer.open({
			type: 2,
			title: '注册账号',
			shadeClose: true,
			shade: 0.2,
			area: ['488px', '439px'],
			content: 'register.page'
		});
	}

	//忘记密码
	function forgetPassword(){
		layer.open({
			type: 2,
			title: '忘记密码',
			shadeClose: true,
			shade: 0.2,
			area: ['490px', '318px'],
			content: 'forgetPassword.page?user='+user
		});
	}

	//手机登录
	$("#phonelogin").click(function(){
		var imgSrc = $("#qrImg").attr("src");
		if (imgSrc == "" || imgSrc == undefined){
			$.ajax({
				type: 'POST',
				url: rootUrl+'showQRCode.do',
				//dataType:'json',
				async:false,
				success: function(result) {
					$("#qrImg").css("display","block");
					$("#qrImg").attr("src",result);
				}
			});
		}else{
			$("#qrImg").attr("src","");
			$("#qrImg").css("display","none");
		}
	})

	//关闭/开启动画
	function openGame(thisObj){
		var text=$(thisObj).text();
		if (backgroundAnimation){
            $("#iframePage").attr("src", "");
            backgroundAnimation = false;
		}else{
            $("#iframePage").attr("src", rootUrl+"canvas/snow.page");
            backgroundAnimation = true;
		}
	}

	//玩游戏
	function playGame(){
		window.location.href = rootUrl + "canvas/canvasIndex.page";
	}

	//定时滚动登陆页背景图片
	$.ws.backgroundImgAnimation("backgroundImg","mainDiv", 3, 10)

	//模拟登录前的检查操作
	var checkEnvTimer = null;
	var isCheckFinish = false;
	var textArr = new Array();
	function checkEnvironment(){
		console.log("触发登录前的点击事件");
		if (!checkBeforeLogin){
		    return true;
        }
		$.ajax({
			type: 'GET',
			url: rootUrl+'querySystemInfo',
			async:false,
			success: function(result) {
				if (result.code == 1){
					var data = result.data;
					var osName = data.osName;
					var javaHome = data.javaHome;
					var javaVersion = data.javaVersion;
					var dbVersion = data.dbVersion;
					var nginxFlag = data.nginxFlag;
					var shareDir = data.shareDir;
					textArr = new Array("正在检查系统版本.....",osName,
							"正在检查java版本.....",javaVersion,
							"正在检查java家目录.....",javaHome,
							"正在检查数据库版本.....",dbVersion,
							"正在检查nginx进程状态.....", nginxFlag,
							"正在检查共享目录权限.....",shareDir,
							"正在检查其他事项....","检查完毕",
							"登录中.........","","","");
				}
			}
		});
		var text = "";
		var i = 0;
		if (null == checkEnvTimer && !isCheckFinish && textArr.length>0) {
			$("#checkDiv").css("display", "block");
			checkEnvTimer = setInterval(function () {
				if (i >= textArr.length) {
					isCheckFinish = true;
					if (null != checkEnvTimer) {
						checkEnvTimer = null;
						console.log("清理定时器")
						clearInterval(checkEnvTimer);
						$("#checkDiv").css("display", "none");
						$("#loginForm").submit();
					}
				}else{
					text += "<span style='height:20px;color:white;display:inline-block;margin-bottom: 5px;'>" + textArr[i] + "</span><br/>";
					$("#checkContentDiv").html(text);
				}
				i++;
			}, 200);
		}
		return isCheckFinish;
	}

	//当浏览器大小变化时
    resizeWindows();
	function resizeWindows(){
        winInnerWidth = window.innerWidth;
        winInnerHeight = window.innerHeight;
        var mainDivWidth = $("#mainDiv").width();
        var mainDivHeight = $("#mainDiv").height();
        if (winInnerWidth>=mainDivWidth) {
            $("#mainDiv").css("left", (winInnerWidth - mainDivWidth) / 2 + "px");
        }
        if (winInnerHeight>=mainDivHeight) {
            $("#mainDiv").css("top", (winInnerHeight - mainDivHeight) / 2 + "px");
        }
	}
	$(window).resize(resizeWindows);

	// 获取验证码
    generateVerifyCode();
    $("#verifyCodeImg").click(generateVerifyCode);
    function generateVerifyCode() {
        $.ajax({
            type: 'GET',
            url: rootUrl + 'generateVerifyCode.do',
            async: false,
            success: function (result) {
                if (result.code == 1) {
                    $("#verifyCodeImg").attr("src", result.data);
                }
            }
        });
    }

	// 勾选登陆前检查事件
    $("#checkFlag").click(function(){
        var isChecked = $(this).attr("checked");
        if (isChecked){
            checkBeforeLogin = false;
            $(this).removeAttr("checked");
        }else{
            checkBeforeLogin = true;
            $(this).attr("checked","checked");
        }
    });

    // 切换语言
    $("#localesSelect").change(function() {
        var lang = $("#localesSelect").val();
        if (lang != "") {
            $("#locale").val(lang);
            window.location.replace("/i18n?lang=" + lang);
        }
    });
</script>
</html>
